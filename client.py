#!/usr/bin/env python3
import requests
import argparse
import sys

def download_hash(url, sha256hash):
    #sha256hash = "094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d"
    filename = sha256hash+".zip"
    print(f"\n[*] Downloading...")
    data = {'query':'get_file', 'sha256_hash':f"{sha256hash}"}
    r = requests.post(url, data=data)
    with open(f'{filename}', 'wb') as f:
        f.write(r.content)
        print(f"[*] Sample saved as {filename}")
        print(f"[*] Password zip file: infected")      

def hash_info(url, sha256hash):
    #sha256hash = "094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d"
    data = {'query':'get_info', 'hash':f"{sha256hash}"}
    print(data)
    r = requests.post(url, data=data)
    print(f"[*] Printing raw info now.... ")
    print(r.text)

def tag_info(url, tag, limit=3):
    data = {'query':'get_taginfo','tag':f'TrickBot','limit':f'{limit}'}
    r = requests.post(url, data)
    print(f"[*] Printing {limit} tags {tag}")
    print(r.text)


def main():
    #API URL
    url = "https://mb-api.abuse.ch/api/v1/"       
    #argument parsing
    parser = argparse.ArgumentParser()
    parser.add_argument('-l', '--limit', help="limit the number of items on your search, default 3", required=False)
    parser.add_argument('-t', '--tag', help="Tag to search for it, eg: TrickBot ", required=False)
    parser.add_argument('-d', '--download', help="Download the provided SHA-256 hash sample",action='store_true', required=False)
    parser.add_argument('-s', '--sha256hash' , help="SHA-256 Hash ow the sample", required=False)
    parser.add_argument('-i', '--info', help="Information of the provided SHA-256 hash", action='store_true', required=False)

    args = parser.parse_args()
    
    if len(sys.argv)==1:
        parser.print_help(sys.stderr)
        sys.exit(1)

    if args.tag:
        tag_info(url, args.tag, args.limit)

    if args.download:
        if args.sha256hash:
            download_hash(url, args.sha256hash)
        else:
            print(f"[!] You need to provide a SHA-256 hash")
    if args.info:
        if args.sha256hash:
            print("[*] Requested info for tag {tag}")
            hash_info(url, args.sha256hash)
        else:
            print("[!] You need to provide a SHA-256 hash")

if __name__ == '__main__':
    main()

    